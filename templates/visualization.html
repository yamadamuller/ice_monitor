<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!--touchscreen pode interagir com o site-->
        <title>{{sensorname}}</title>
        <link rel="icon" type="image/x-icon" href="https://nuem.ct.utfpr.edu.br/wp-content/uploads/2021/05/favicon.ico">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Text:wght@400;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Red Hat Text', sans-serif;
                text-align: justify;
                text-justify: inter-word;
                margin: 0;
                padding: 0;
                position: relative;
                min-height: 100vh;
            }

            .highlight-color{
                color: #4A88C3;
            }

            .content {
                max-width: 800px;
                margin: 100px auto 40px;
                padding: 0 20px;
                line-height: 1.6;
                font-size: 1.1rem;
                color: #333;
            }

            .fixed{
                position: fixed;
            }

            .top-0{
                top: 0;
            }

            .left-0{
                left: 0;
            }

            .right-0{
                right: 20;
            }

            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(.4,0,.2,1);
                transition-duration: .15s;
            }

            .duration-300 {
                animation-duration: .3s;
            }

            .py-5 {
                padding-top: 1.25rem;
                padding-bottom: 1.25rem;
            }

             .items-center {
                align-items: center;
            }

            .img-responsive {
                max-width: 10%;
            }

            .ico_enhanced {
                width: 200%;
                height: 200%;
            }
        </style>
    </head>

    <body class="content">
        <header class="fixed top-0 right-0 left-0 transition-all duration-300 py-5">
            <a class="flex items-center" href="/">
                <img src="https://nuem.ct.utfpr.edu.br/wp-content/uploads/2020/10/Marca-horizontal_texto-em-ingles.png"
                     alt="nuem_logo" width="15%" height="15%">
            </a>
        </header>

        <div>
            <h1 class="highlight-color">Constellation</h1>
            Sensor: <pre id="sensorId" style="display:inline">{{sensorname}}</pre><br>
            Hostname: <pre id="hostId" style="display:inline">{{hostname}}</pre><br>
            Endpoint:  <pre id="wsaddrId" style="display:inline">{{socketaddress}}</pre><br>
            Status: <pre id="connStatus" style="display:inline"></pre><br>
            Ideal sampling rate: <pre id="IdealSamplingId" style="display:inline" class="highlight-color">{{sensorname}}: Avg. samples/s {{idealrate}}</pre><br>
            Real-time sampling rate: <pre id="samplingId" style="display:inline" class="highlight-color"></pre><br>
        </div>

        <div id="plot"></div>

        <script>
            const evtSource = new EventSource("/sensor_specific_stats");
            evtSource.onmessage = function(event) {
                let lines;
                const samplingId = document.getElementById("samplingId");
                const connStatus = document.getElementById("connStatus");
                const sensor_filter = "{{sensorname}}";
                lines = event.data.split(',');
                lines = lines.filter(item=>item.includes(sensor_filter));

                if (lines.length>0){
                    connStatus.textContent = "connected";
                    connStatus.style.color = "green";
                }
                else{
                    connStatus.textContent = "disconnected";
                    connStatus.style.color = "red";
                }

                samplingId.textContent = lines.join('').replace(']', '');
                samplingId.scrollTop = stdoutBox.scrollHeight;
            };

            evtSource.onerror = function(err) {
                console.error("SSE connection error:", err);
            };
        </script>

        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        <script>
            const sensor = "{{sensorname}}";
            Plotly.newPlot("plot", [
                {x: [], y: [], mode: "lines", name: "fdc1"},
                {x: [], y: [], mode: "lines", name: "fdc2"}
            ], {
                title: "Real-time data",
                xaxis: {title: "Time"},
                yaxis: {title: "Capacitance [fF]"}
            },
            {responsive: true});

            async function updatePlot() {
                const res = await fetch("/api/{{sensorname}}");
                const data = await res.json();
                const timestamp = data.time.map(t => {
                    const ns = BigInt(t);
                    const ms = Number(ns / 1_000_000n);
                    return new Date(ms).toISOString();
                });


                Plotly.update("plot", {
                    x: [timestamp, timestamp],
                    y: [data.fdc1, data.fdc2]
                });
            }

            setInterval(updatePlot, 100);  // update every second
        </script>
    </body>
</html>
